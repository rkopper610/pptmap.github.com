---
title: "Survey variables analysis to produce Sanky Diagram"
author: "Ryan Kopper"
date: "5/22/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
## load libraries
library(dplyr)
#info sheet https://github.com/rstudio/cheatsheets/blob/master/data-transformation.pdf
library(networkD3)
library(tidyverse)
library(readxl)
library(readr)

#Read in each sheet individually which creates a Tibble for each.

Relationships <- read_excel("/Users/ryankopper/Clark University/Morgan Ruelle - Ryan Kopper Research/Push Pull Systematic Review/Survey relationships 2020_05_19.xlsx", sheet = "Relationships")

Independent_recode <- read_excel("/Users/ryankopper/Clark University/Morgan Ruelle - Ryan Kopper Research/Push Pull Systematic Review/Survey relationships 2020_05_19.xlsx", sheet = "Independent recode")

Dependent_recode <- read_excel("/Users/ryankopper/Clark University/Morgan Ruelle - Ryan Kopper Research/Push Pull Systematic Review/Survey relationships 2020_05_19.xlsx", sheet = "Dependent recode")

```

Join independent/dependent variable of recode table to original,

https://www.infoworld.com/article/3454356/how-to-merge-data-in-r-using-r-merge-dplyr-or-datatable.html

The first step is some kind of join command 

the second one is using the joined columns to create a new matrix with counts.

alter long data to wide data with value as counts.

https://datacarpentry.org/R-ecology-lesson/03-dplyr.html
```{r}

joined_long <- left_join( Relationships, Independent_recode, by = "Independent_variable") %>% left_join(Dependent_recode, by = "Dependent_variable") %>%  select(Independent_variable_recode, Dependent_variable_recode) %>% group_by(Independent_variable_recode, Dependent_variable_recode) %>% summarise(count = n()) 

joined_matrix <- left_join( Relationships, Independent_recode, by = "Independent_variable") %>% left_join(Dependent_recode, by = "Dependent_variable") %>%  select(Independent_variable_recode, Dependent_variable_recode) %>% group_by(Independent_variable_recode, Dependent_variable_recode) %>% summarise(count = n()) %>% spread(key = Dependent_variable_recode, value = count) %>% replace(is.na(.), 0 )

# glimpse(joined_tibble)
# str(joined_tibble)

```


```{r}
require(scales)
library(RColorBrewer)

ggplot(joined_long, aes(x = Dependent_variable_recode, y = Independent_variable_recode, color = count )) + geom_point(aes(size = count)) + theme(axis.text.x = element_text(angle = 90, vjust = .5 ,  hjust = 1)) + scale_x_discrete(labels = label_wrap(20)) + scale_y_discrete(labels = label_wrap(30)) 



#polish graph and note the oberservations

#change gradient to more distinct colors

#removed doubled count key
g1 <- ggplot(joined_long, aes(x = Dependent_variable_recode, y = Independent_variable_recode, color = count)) + geom_point(aes(size = count)) + theme(axis.text.x = element_text(angle = 90, vjust = .5 ,  hjust = 1)) + scale_x_discrete(labels = label_wrap(20)) + scale_y_discrete(labels = label_wrap(30)) + guides(size = FALSE) + xlab("Dependent variable") + ylab("Independent variable")

#COLOR OPTIONS

#change color to green
g1 + scale_color_gradient(low = 'greenyellow', high = 'darkgreen') + guides(size = FALSE) 

#change color to green
g1 + scale_color_gradient2(low = 'orange', mid = 'white', high = 'purple') + guides(size = FALSE) 

#look into fixing the x axis text labels to have multiple lines


ggplot(joined_long, aes(x = Dependent_variable_recode, y = Independent_variable_recode, color = count )) + geom_point(aes(size = count)) + theme(axis.text.x = element_text(angle = 90, vjust = .5 ,  hjust = 1)) + scale_x_discrete(labels = label_wrap(20)) + scale_y_discrete(labels = label_wrap(30)) 

```

EXTRA-------------------------------
Use DPLYR to bring together the "relationships" and "recording" sheets
 
```{r}
#Creates value for  each sheet
# sheets <- excel_sheets("/Users/ryankopper/Clark University/Morgan Ruelle - Ryan Kopper Research/Push Pull Systematic Review/Survey relationships 2020_05_19.xlsx")
# 
# #Maps sheets to the data
# #map_df() returns a data frame.
# f <- map_df(sheets, ~ read_excel("/Users/ryankopper/Clark University/Morgan Ruelle - Ryan Kopper Research/Push Pull Systematic Review/Survey relationships 2020_05_19.xlsx", sheet = .x))

#f = all the sheets combined.
```





SANKEY DIAGRAMS

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#SANKEY diagrams consist of three sets of elements: the nodes, the links, and the instructions which determine their positions

#trying the following pckages
library(plotly)
#or
library(networkD3)

links2 <- read_excel("/Users/ryankopper/Clark University/Morgan Ruelle - Ryan Kopper Research/Push Pull Systematic Review/Survey relationships 2020_05_19.xlsx", sheet = "links")

nodes2 <- read_excel("/Users/ryankopper/Clark University/Morgan Ruelle - Ryan Kopper Research/Push Pull Systematic Review/Survey relationships 2020_05_19.xlsx", sheet = "nodes") 


```
https://www.youtube.com/watch?v=S6me1r6RI4I

Nodes
"networkD3" Package

https://towardsdatascience.com/using-networkd3-in-r-to-create-simple-and-clear-sankey-diagrams-48f8ba8a4ace

```{r}
sankeyNetwork(Links = links2, Nodes = nodes2, Source = "source", 
              Target = "Target", Value = "value", NodeID = "name", 
              fontSize = 12, nodeWidth = 13,
              fontFamily = "sans serif", iterations = 0)

```
CREATING IT IN R
```{r}
#
# create nodes dataframe

results <- joined_long %>% 
  dplyr::group_by(Independent_variable_recode) %>% 
  dplyr::summarise(Remain = sum(Remain), Leave = sum(Leave))


IV <- unique(as.character(joined_long$Independent_variable_recode))
nodes <- data.frame(node = c(0:18))


#create links dataframe
IV <- merge(IV, nodes, by.x = "Region", by.y = "name")
IV <- merge(IV, nodes, by.x = "result", by.y = "name")
links <- IV[ , c("node.x", "node.y", "vote")]
colnames(links) <- c("source", "target", "value") 
                   
```

